# é˜¿é‡Œäº‘äº‘æ•ˆ Flow æµæ°´çº¿é…ç½®æ–‡ä»¶
# é€‚ç”¨äºäº‘æ•ˆ Flow æœåŠ¡è‡ªåŠ¨åŒ–éƒ¨ç½²

version: '1.0'

name: voice-chat-app-pipeline

# è§¦å‘æ¡ä»¶
triggers:
  - type: push
    branches:
      - main
      - master
  - type: manual

# ç¯å¢ƒå˜é‡ (åœ¨äº‘æ•ˆæ§åˆ¶å°é…ç½®)
# ECS_IP: ECS å…¬ç½‘ IP
# ALIYUN_APP_ID: é˜¿é‡Œäº‘ RTC App ID
# ALIYUN_APP_KEY: é˜¿é‡Œäº‘ RTC App Key
# DOCKER_REGISTRY_USERNAME: é•œåƒä»“åº“ç”¨æˆ·å
# DOCKER_REGISTRY_PASSWORD: é•œåƒä»“åº“å¯†ç 

# æµæ°´çº¿é˜¶æ®µ
stages:
  # é˜¶æ®µ 1: æ„å»º Docker é•œåƒ
  - name: build
    displayName: æ„å»º Docker é•œåƒ
    jobs:
      - name: docker-build
        displayName: æ„å»ºå¹¶æ¨é€é•œåƒ
        steps:
          - name: Checkout
            step: git-clone@1
            with:
              depth: 1

          - name: Docker Login
            step: execute-shell@1
            with:
              script: |
                echo "ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
                echo ${DOCKER_REGISTRY_PASSWORD} | docker login \
                  --username=${DOCKER_REGISTRY_USERNAME} \
                  --password-stdin \
                  registry.cn-hangzhou.aliyuncs.com

          - name: Build Image
            step: docker-build@1
            with:
              context: .
              dockerfile: Dockerfile
              image: registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app
              tags:
                - ${PIPELINE_ID}
                - latest
              push: true
              buildArgs: []

          - name: Image Info
            step: execute-shell@1
            with:
              script: |
                echo "âœ… é•œåƒæ„å»ºæˆåŠŸ!"
                echo "é•œåƒåœ°å€: registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app:${PIPELINE_ID}"
                echo "Latest: registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app:latest"

  # é˜¶æ®µ 2: éƒ¨ç½²åˆ° ECS
  - name: deploy
    displayName: éƒ¨ç½²åˆ° ECS
    depends_on:
      - build
    jobs:
      - name: ecs-deploy
        displayName: éƒ¨ç½²åº”ç”¨åˆ° ECS
        steps:
          - name: Deploy via SSH
            step: ssh-execute@1
            with:
              host: ${ECS_IP}
              username: root
              # ä½¿ç”¨ SSH å¯†é’¥è®¤è¯ (åœ¨äº‘æ•ˆæ§åˆ¶å°é…ç½®)
              authType: key
              script: |
                set -e
                
                echo "ğŸš€ å¼€å§‹éƒ¨ç½² voice-chat-app..."
                
                # æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
                if ! command -v docker &> /dev/null; then
                    echo "âŒ Docker æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
                    curl -fsSL https://get.docker.com | bash
                    systemctl start docker
                    systemctl enable docker
                fi
                
                # ç™»å½•é•œåƒä»“åº“
                echo "ğŸ” ç™»å½•é•œåƒä»“åº“..."
                echo ${DOCKER_REGISTRY_PASSWORD} | docker login \
                  --username=${DOCKER_REGISTRY_USERNAME} \
                  --password-stdin \
                  registry.cn-hangzhou.aliyuncs.com
                
                # æ‹‰å–æœ€æ–°é•œåƒ
                echo "â¬‡ï¸  æ‹‰å–é•œåƒ..."
                docker pull registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app:${PIPELINE_ID}
                
                # åœæ­¢æ—§å®¹å™¨
                echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
                docker stop voice-chat 2>/dev/null || true
                docker rm voice-chat 2>/dev/null || true
                
                # å¯åŠ¨æ–°å®¹å™¨
                echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
                docker run -d \
                  --name voice-chat \
                  --restart unless-stopped \
                  -p 80:80 \
                  -p 3001:3001 \
                  -e ALIYUN_APP_ID=${ALIYUN_APP_ID} \
                  -e ALIYUN_APP_KEY=${ALIYUN_APP_KEY} \
                  -e NODE_ENV=production \
                  --log-opt max-size=10m \
                  --log-opt max-file=3 \
                  registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app:${PIPELINE_ID}
                
                # ç­‰å¾…å®¹å™¨å¯åŠ¨
                echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
                sleep 10
                
                # å¥åº·æ£€æŸ¥
                echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
                if curl -f http://localhost/health > /dev/null 2>&1; then
                    echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
                else
                    echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
                    docker logs --tail 50 voice-chat
                fi
                
                # æ¸…ç†æ—§é•œåƒ
                echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
                docker image prune -f
                
                # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
                echo ""
                echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
                docker ps | grep voice-chat || echo "âŒ å®¹å™¨æœªè¿è¡Œ"
                
                echo ""
                echo "âœ… éƒ¨ç½²å®Œæˆ!"

          - name: Verify Deployment
            step: execute-shell@1
            with:
              script: |
                echo "ğŸ” éªŒè¯éƒ¨ç½²..."
                
                # ç­‰å¾…å‡ ç§’é’Ÿè®©åº”ç”¨å®Œå…¨å¯åŠ¨
                sleep 5
                
                # æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯è®¿é—®
                if curl -f http://${ECS_IP}/health > /dev/null 2>&1; then
                    echo "âœ… åº”ç”¨å¯è®¿é—®: http://${ECS_IP}"
                else
                    echo "âš ï¸  åº”ç”¨æš‚æ—¶æ— æ³•è®¿é—®ï¼Œè¯·æ£€æŸ¥ ECS å®‰å…¨ç»„é…ç½®"
                fi

  # é˜¶æ®µ 3: é€šçŸ¥ (å¯é€‰)
  - name: notify
    displayName: é€šçŸ¥
    depends_on:
      - deploy
    jobs:
      - name: send-notification
        displayName: å‘é€éƒ¨ç½²é€šçŸ¥
        steps:
          - name: Notification
            step: execute-shell@1
            with:
              script: |
                echo "ğŸ“§ éƒ¨ç½²é€šçŸ¥"
                echo "åº”ç”¨: voice-chat-app"
                echo "ç¯å¢ƒ: Production"
                echo "é•œåƒ: registry.cn-hangzhou.aliyuncs.com/voice-chat/voice-chat-app:${PIPELINE_ID}"
                echo "è®¿é—®åœ°å€: http://${ECS_IP}"
                echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
                
                # å¦‚éœ€é›†æˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼Œå¯åœ¨æ­¤æ·»åŠ  webhook è°ƒç”¨

# æ¸…ç†ç­–ç•¥
cleanup:
  # ä¿ç•™æœ€è¿‘ 10 æ¬¡æ„å»ºçš„é•œåƒ
  images:
    keep: 10
